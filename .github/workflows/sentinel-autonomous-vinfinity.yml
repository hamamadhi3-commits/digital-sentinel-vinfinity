name: sentinel-autonomous-vinfinity
on:
  workflow_dispatch:

jobs:
  eternal-hunter:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max runtime

    steps:
      - name: ğŸ§  Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install -r requirements.txt || true
          echo "âœ… Dependencies installed"

      - name: ğŸ§© Ensure src Package Initialization
        run: |
          if [ ! -f "src/__init__.py" ]; then
            echo "âš™ï¸ Creating missing __init__.py inside src/"
            touch src/__init__.py
          else
            echo "âœ… src/__init__.py already exists"
          fi

      - name: ğŸ”§ Fix Python Import Path
        run: |
          echo "ğŸ”§ Adding current path to PYTHONPATH"
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          echo "PYTHONPATH=$PYTHONPATH" >> $GITHUB_ENV
          echo "âœ… PYTHONPATH fixed"

      - name: ğŸ§  Detect Quantum Core
        run: |
          echo "ğŸ” Checking for quantum_immortal_loop.py..."
          if [ -f "src/quantum_immortal_loop.py" ]; then
            echo "core=src/quantum_immortal_loop.py" >> $GITHUB_ENV
            echo "ğŸŒ€ Quantum Immortal Loop found!"
          else
            echo "core=src/main_controller_v11_4_quantum.py" >> $GITHUB_ENV
            echo "âš™ï¸ Defaulting to main_controller_v11_4_quantum.py"
          fi

      - name: ğŸš€ Launch Eternal Quantum Intelligence
        run: |
          echo "ğŸš€ Running core: $core"
          chmod +x $core
          python3 $core || (
            echo "âš ï¸ Crash detected, retrying in 30 seconds..." && sleep 30 && python3 $core
          )

      - name: ğŸ“¡ Dispatch Discord Report
        if: always()
        run: |
          echo "ğŸ“¡ Sending summary report to Discord (if configured)..."
          if [ -f "src/discord_reporter.py" ]; then
            python3 src/discord_reporter.py || echo "âš ï¸ Discord reporting failed, skipping..."
          else
            echo "âš ï¸ discord_reporter.py not found, skipping Discord stage."
          fi

      - name: ğŸ“ Archive Reports
        if: always()
        run: |
          mkdir -p artifacts
          find . -type f -name "*.log" -o -name "*.txt" -o -name "*.json" | tar -czf artifacts/reports.tar.gz -T -
          echo "ğŸ“¦ Reports archived"

      - name: ğŸ“¤ Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: digital-sentinel-reports
          path: artifacts/

      - name: â™¾ï¸ Quantum Continuity Loop
        if: always()
        run: |
          echo "â™¾ï¸ Eternal Quantum Loop complete. System ready for next cycle."
