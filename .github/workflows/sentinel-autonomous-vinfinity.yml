name: sentinel-autonomous-vinfinity
on:
  workflow_dispatch:

jobs:
  eternal-hunter:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 6 hours
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: ğŸ§  Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Requirements
        run: |
          python3 -m pip install --upgrade pip
          pip install -r requirements.txt || true
          echo "âœ… Python dependencies installed."

      - name: ğŸ§© Ensure src is a Package
        run: |
          if [ ! -f "src/__init__.py" ]; then
            echo "âš™ï¸ Creating __init__.py"
            touch src/__init__.py
          fi
          echo "âœ… src initialized."

      - name: ğŸ”§ Fix PYTHONPATH
        run: |
          echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV
          echo "âœ… PYTHONPATH fixed."

      - name: ğŸ” Detect Quantum Core
        id: detect_core
        run: |
          if [ -f "src/quantum_immortal_loop.py" ]; then
            echo "core=src/quantum_immortal_loop.py" >> $GITHUB_ENV
            echo "ğŸŒ€ Core detected: quantum_immortal_loop.py"
          else
            echo "core=src/main_controller_v11_4_quantum.py" >> $GITHUB_ENV
            echo "âš™ï¸ Fallback: main_controller_v11_4_quantum.py"
          fi

      - name: ğŸš€ Launch Eternal Quantum Intelligence
        run: |
          echo "ğŸš€ Running core: $core"
          chmod +x $core
          python3 $core || (
            echo "âš ï¸ Crash detected â€” retrying once after 30s..." && sleep 30 && python3 $core
          )

      - name: ğŸ“¡ Send Discord Report
        if: always()
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            echo "ğŸ“¨ Sending report to Discord..."
            python3 src/discord_reporter.py "$DISCORD_WEBHOOK_URL" || echo "âš ï¸ Discord send failed."
          else
            echo "âš ï¸ No Discord webhook configured."
          fi

      - name: ğŸ§¾ Archive Reports
        if: always()
        run: |
          mkdir -p artifacts
          find . -type f -name "*.log" -o -name "*.txt" -o -name "*.json" | tar -czf artifacts/reports.tar.gz -T -
          echo "ğŸ“¦ Reports archived."

      - name: ğŸ“¤ Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: digital-sentinel-reports
          path: artifacts/

      - name: â™¾ï¸ Self-Restart (Quantum Regeneration Loop)
        if: always()
        run: |
          echo "â™»ï¸ Quantum Cycle Complete â€” restarting in 30 seconds..."
          sleep 30
          gh workflow run sentinel-autonomous-vinfinity.yml || echo "âš ï¸ Auto-restart failed."
